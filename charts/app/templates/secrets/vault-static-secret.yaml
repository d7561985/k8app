{{/*
Vault Secrets Operator - VaultStaticSecret resources
Creates VaultStaticSecret for each unique Vault path in secrets map.
Each path gets its own K8s Secret with filtered keys via transformation.includes.

Requires: HashiCorp Vault Secrets Operator (VSO) installed in cluster
Docs: https://developer.hashicorp.com/vault/docs/deploy/kubernetes/vso
*/}}
{{- if eq (include "secrets.isVaultEnabled" .) "true" }}
{{- $appname := include "name" . -}}
{{- $namespace := .Release.Namespace -}}
{{- $vaultConfig := .Values.secretsProvider.vault -}}
{{- $root := . -}}

{{- /* Group secrets by resolved Vault path */ -}}
{{- $secretsByPath := dict -}}
{{- range $envVar, $pathTemplate := .Values.secrets -}}
{{- $resolvedPath := include "secrets.resolvePath" (dict "path" $pathTemplate "root" $root) -}}
{{- $existing := get $secretsByPath $resolvedPath | default list -}}
{{- $_ := set $secretsByPath $resolvedPath (append $existing $envVar) -}}
{{- end -}}

{{- /* Sort paths for stable ordering (prevents ArgoCD diff on reorder) */ -}}
{{- $sortedPaths := keys $secretsByPath | sortAlpha -}}

{{- /* Create VaultStaticSecret for each unique path */ -}}
{{- range $pathIndex, $path := $sortedPaths }}
{{- $envVars := get $secretsByPath $path }}
---
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: {{ $appname }}-vault-{{ $pathIndex }}
  namespace: {{ $namespace }}
  labels:
    app: {{ $appname }}
    chart: "{{ $root.Chart.Name }}-{{ $root.Chart.Version }}"
    release: "{{ $root.Release.Name }}"
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
    app.kubernetes.io/version: {{ include "k8app.labelVersion" $root | quote }}
    vault-source-path: {{ $path }}
spec:
  type: {{ $vaultConfig.type | default "kv-v2" }}
  mount: {{ $vaultConfig.mount | default "secret" }}
  path: {{ $path }}
  refreshAfter: {{ $vaultConfig.refreshAfter | default "1h" }}
  vaultAuthRef: {{ $vaultConfig.authRef | default "vault-auth" }}
  destination:
    name: {{ $appname }}-vault-{{ $pathIndex }}
    create: true
    overwrite: true
    transformation:
      excludeRaw: true
      includes:
        {{- range $envVars }}
        - ^{{ . }}$
        {{- end }}
{{- end }}
{{- end }}
