{{- if .Values.cronjob.enabled -}}
  {{- $root := . -}}
  {{- $appname := printf "%s" (include "name" .) -}}
  {{- $cronJobName :=  printf "%s-%s" (include "name" .) "cron" -}}
  {{- range $key, $value := .Values.cronjob.spec }}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  namespace: "{{ $root.Release.Namespace }}"
  labels:
    helm.sh/chart: "{{ $root.Chart.Name }}-{{ $root.Chart.Version }}"
    cronjob: "{{ $cronJobName }}"
    chart: "{{ $root.Chart.Name }}-{{ $root.Chart.Version }}"
    release: "{{ $root.Release.Name }}"
  name: "{{ $cronJobName }}-{{ $key }}"
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 10
  jobTemplate:
    metadata:
      name: "{{ $cronJobName }}-{{ $key }}"
      labels:
        helm.sh/chart: "{{$root.Chart.Name}}-{{$root.Chart.Version}}"
        cronjob: "{{ $cronJobName }}"
    spec:
      template:
        spec:
        {{- if $.Values.serviceAccountName }}
          serviceAccountName: {{ $.Values.serviceAccountName}}
        {{- else if $.Values.rbac.create }}
          serviceAccountName: {{ $.Release.Namespace }}-{{ $appname }}
        {{- end }}
        {{- /* CSI volume only for AWS provider or legacy mode (not for Vault) */ -}}
        {{- if and $root.Values.secrets (or (not $root.Values.secretsProvider) (ne $root.Values.secretsProvider.provider "vault")) }}
          volumes:
            - name: secrets-store-inline
              csi:
                driver: secrets-store.csi.k8s.io
                readOnly: true
                volumeAttributes:
                  secretProviderClass: {{ $appname }}-aws-secrets
        {{- end }}
          containers:
          - name: "{{ $key }}"
            command:
            {{- range $value.command}}
            - {{ . | quote }}
            {{- end }}
            args:
            {{- range $value.args}}
            - {{ . | quote }}
            {{- end }}
        {{- if or $root.Values.secrets $root.Values.configmap }}
            envFrom:
            {{- if $root.Values.configmap }}
            - configMapRef:
                name: "{{ $appname }}"
            {{- end }}
            {{- if and $root.Values.secrets (eq (include "secrets.isVaultEnabled" $root) "true") }}
            {{- $secretsByPath := dict -}}
            {{- range $envVar, $pathTemplate := $root.Values.secrets -}}
            {{- $resolvedPath := include "secrets.resolvePath" (dict "path" $pathTemplate "root" $root) -}}
            {{- $_ := set $secretsByPath $resolvedPath true -}}
            {{- end -}}
            {{- $sortedPaths := keys $secretsByPath | sortAlpha -}}
            {{- range $pathIndex, $path := $sortedPaths }}
            - secretRef:
                name: {{ $appname }}-vault-{{ $pathIndex }}
            {{- end }}
            {{- end }}
        {{- end }}
            env:
            - name: BUILD_ID
              value: {{ $root.Values.buildId | quote | default "000" }}
            - name: SENTRY_ENVIRONMENT
              value: {{ $root.Values.environment | quote }}
            - name: SENTRY_RELEASE
              value: {{ $root.Values.image.tag | quote }}
            {{- if $root.Values.tracingEnabled }}
            - name: JAEGER_AGENT_BINARY_PORT
              value: "6832"
            - name: JAEGER_AGENT_COMPACT_PORT
              value: "6831"
            - name: JAEGER_AGENT_SAMPLING_PORT
              value: "5778"
            - name: JAEGER_AGENT_ZIPKIN_THRIFT_PORT
              value: "5775"
            - name: JAEGER_AGENT_HOST
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: status.hostIP
            {{- end }}
        {{- /* CSI volume mount only for AWS provider or legacy mode */ -}}
        {{- if and $root.Values.secrets (or (not $root.Values.secretsProvider) (ne $root.Values.secretsProvider.provider "vault")) }}
            volumeMounts:
              - name: secrets-store-inline
                mountPath: "/mnt/secrets-store"
        {{- end }}
            image: "{{ $root.Values.image.repository }}:{{ $root.Values.image.tag }}"
            imagePullPolicy: Always
        {{- if $root.Values.nodeSelector }}
          nodeSelector:
          {{ toYaml $root.Values.nodeSelector | indent 8 }}
        {{- end }}
          restartPolicy: Never
          terminationGracePeriodSeconds: 30
  schedule: {{ default "1 * * * *" $value.schedule | quote }}
  startingDeadlineSeconds: 300
  successfulJobsHistoryLimit: 3
  suspend: false
  {{- end -}}
{{- end -}}
